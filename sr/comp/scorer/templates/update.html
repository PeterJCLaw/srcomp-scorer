{% extends "_base.html" %}

{% block head %}
    <link href="{{ url_for('static', filename='styles/score-sheet.css') }}" rel="stylesheet" />
{% endblock %}

{% block hint %}
    <p>
        <a href="{{ url_for('.index') }}">Return to match selection</a>
        <a href="{{ url_for('.update', arena=match.arena, num=match.num - 1) }}">Previous match</a>
        <a href="{{ url_for('.update', arena=match.arena, num=match.num + 1) }}">Next match</a>

        {% for name, arena in arenas.items() %}
            {% if name != match['arena'] %}
                <a href="{{ url_for('.update', arena=name, num=match.num) }}">Arena {{ arena.display_name }}</a>
            {% endif %}
        {% endfor %}
    </p>
{% endblock %}

{% macro input_tla(x, y, corner) %}
    {% set current = request.form.get('tla_{}'.format(corner)) %}
    <foreignObject x="{{ x }}" y="{{ y }}" width="40" height="30">
        <label for="tla_{{ corner }}">TLA</label>
    </foreignObject>
    <foreignObject x="{{ x + 45 }}" y="{{ y }}" width="100" height="30">
        <select id="tla_{{ corner }}" name="tla_{{ corner }}">
            <option value=""></option>
            {% for tla, team in teams | dictsort %}
                <option value="{{ tla }}" {{ 'selected' if current == tla else '' }}>{{ tla }}</option>
            {% endfor %}
        </select>
    </foreignObject>
{% endmacro %}

{% macro input_zone(x, y, id) %}
    <foreignObject x="{{ x }}" y="{{ y }}" width="100" height="30">
        <input
            type="text"
            class="wide-spaced tokens"
            id="tokens_{{ id }}"
            name="tokens_{{ id }}"
            placeholder="Tokens"
            value="{{ request.form.get('tokens_{}'.format(id)) | empty_if_none }}"
            onkeyup="token_input_change(this);"
        />
    </foreignObject>
    <foreignObject x="{{ x }}" y="{{ y + 50 }}" width="100" height="30">
        <input
            type="text"
            class="robot-tlas"
            id="robot_tlas_{{ id }}"
            name="robot_tlas_{{ id }}"
            placeholder="Robot TLAs"
            value="{{ request.form.get('robot_tlas_{}'.format(id)) | empty_if_none }}"
            onkeyup="robot_tla_input_change(this);"
        />
    </foreignObject>
{% endmacro %}

{% macro input_present(x, y, corner) %}
    <foreignObject x="{{ x }}" y="{{ y }}" width="80" height="30">
        <label for="present_{{ corner }}">Present</label>
    </foreignObject>
    <foreignObject x="{{ x + 85 }}" y="{{ y }}" width="30" height="30">
        <input type="checkbox" id="present_{{ corner }}" name="present_{{ corner }}" value="on" {{ 'checked' if request.form.get('present_{}'.format(corner)) else '' }} />
    </foreignObject>
{% endmacro %}

{% macro input_disqualified(x, y, corner) %}
    <foreignObject x="{{ x }}" y="{{ y }}" width="120" height="30">
        <label for="disqualified_{{ corner }}">Disqualified</label>
    </foreignObject>
    <foreignObject x="{{ x + 125 }}" y="{{ y }}" width="30" height="30">
        <input type="checkbox" id="disqualified_{{ corner }}" name="disqualified_{{ corner }}" value="on" {{ 'checked' if request.form.get('disqualified_{}'.format(corner)) else '' }} />
    </foreignObject>
{% endmacro %}

{% block main %}
    <div class="score-sheet"
    {% set arena_colour_raw = arenas[match['arena']].colour %}
    {% if arena_colour_raw %}
        {% set r, g, b = parse_hex_colour(arena_colour_raw) %}
        style="background: rgba({{ r }}, {{ g }}, {{ b }}, 0.15)"
    {% endif %}
    >
        <h1>
            {{ match['type'].value | title }}
            scores for
            {{ match['display_name'] }}
            {% if arenas|length > 1 %}
                in Arena
                {{ arenas[match['arena']].display_name }}
            {% endif %}
        </h1>

        <form method="POST">
            <svg xmlns="http://www.w3.org/2000/svg" height="840" width="600" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink">
                <g font-size="1.2em" fill="#4d4d4d">
                    <text><tspan y="25" x="125">Zone 0</tspan></text>
                    <text><tspan y="25" x="425">Zone 1</tspan></text>
                    <text><tspan y="820" x="425">Zone 2</tspan></text>
                    <text><tspan y="820" x="125">Zone 3</tspan></text>
                </g>

                <!-- Zone 0 -->
                {{ input_tla(10, 40, 0) }}
                {{ input_present(170, 40, 0) }}
                {{ input_disqualified(130, 70, 0) }}

                <!-- Zone 1 -->
                {{ input_tla(310, 40, 1) }}
                {{ input_present(470, 40, 1) }}
                {{ input_disqualified(430, 70, 1) }}

                <g transform="translate(0, 700)">
                    <!-- Zone 2 -->
                    {{ input_tla(310, 40, 2) }}
                    {{ input_present(170, 40, 2) }}
                    {{ input_disqualified(130, 70, 2) }}

                    <!-- Zone 3 -->
                    {{ input_tla(10, 40, 3) }}
                    {{ input_present(470, 40, 3) }}
                    {{ input_disqualified(430, 70, 3) }}
                </g>

                <g transform="translate(0, 120)">
                    <rect height="600" width="600" stroke="#000" y="0" x="0" stroke-width="1" fill="#f8f7ff"/>
                    <rect height="360" width="360" stroke="#000" y="120" x="120" stroke-width="1" fill="#eeeeee"/>
                    <rect height="120" width="120" stroke="#000" y="240" x="240" stroke-width="1" fill="#f8f7ff"/>

                    <path d="M120 0 V 600" stroke="#000" stroke-width="1"/>
                    <path d="M240 0 V 600" stroke="#000" stroke-width="1"/>
                    <path d="M360 0 V 600" stroke="#000" stroke-width="1"/>
                    <path d="M480 0 V 600" stroke="#000" stroke-width="1"/>

                    <path d="M0 120 H 600" stroke="#000" stroke-width="1"/>
                    <path d="M0 240 H 600" stroke="#000" stroke-width="1"/>
                    <path d="M0 360 H 600" stroke="#000" stroke-width="1"/>
                    <path d="M0 480 H 600" stroke="#000" stroke-width="1"/>

                    {{ input_zone( 10, 20, '0_0') }}
                    {{ input_zone(130, 20, '0_1') }}
                    {{ input_zone(250, 20, '0_2') }}
                    {{ input_zone(370, 20, '0_3') }}
                    {{ input_zone(490, 20, '0_4') }}

                    {{ input_zone( 10, 140, '1_0') }}
                    {{ input_zone(130, 140, '1_1') }}
                    {{ input_zone(250, 140, '1_2') }}
                    {{ input_zone(370, 140, '1_3') }}
                    {{ input_zone(490, 140, '1_4') }}

                    {{ input_zone( 10, 260, '2_0') }}
                    {{ input_zone(130, 260, '2_1') }}
                    {{ input_zone(250, 260, '2_2') }}
                    {{ input_zone(370, 260, '2_3') }}
                    {{ input_zone(490, 260, '2_4') }}

                    {{ input_zone( 10, 380, '3_0') }}
                    {{ input_zone(130, 380, '3_1') }}
                    {{ input_zone(250, 380, '3_2') }}
                    {{ input_zone(370, 380, '3_3') }}
                    {{ input_zone(490, 380, '3_4') }}

                    {{ input_zone( 10, 500, '4_0') }}
                    {{ input_zone(130, 500, '4_1') }}
                    {{ input_zone(250, 500, '4_2') }}
                    {{ input_zone(370, 500, '4_3') }}
                    {{ input_zone(490, 500, '4_4') }}


                </g>
            </svg>

            <input type="hidden" name="force" />
            <input type="submit" value="Enter Scores" />
        </form>
    </div>

    {% if error %}
        <aside class="dialogue fail">
            <div>
                <h1>Validation Error!</h1>
                <pre>{{ error }}</pre>
                <button data-action="hide">Correct problems</button>
                <button data-action="force">Save anyway</button>
            </div>
        </aside>
    {% elif done %}
        <aside class="dialogue success">
            <div>
                <h1>Success!</h1>
                <p>The scores have been updated successfully.</p>

                <button data-action="url" data-url="{{ url_for('.index') }}">Select another match</button>
                <button data-action="url" data-url="{{ url_for('.update', arena=match.arena, num=match.num - 1) }}">Previous match</button>
                <button data-action="url" data-url="{{ url_for('.update', arena=match.arena, num=match.num + 1) }}">Next match</button>

                {% for name, arena in arenas.items() %}
                    {% if name != match['arena'] %}
                        <button data-action="url" data-url="{{ url_for('.update', arena=name, num=match.num) }}">Arena {{ arena.display_name }}</button>
                    {% endif %}
                {% endfor %}

                <button data-action="hide">Amend scores</button>
            </div>
        </aside>
    {% endif %}

    {% if error or done %}
        <script>
            var dialogue = document.querySelector('aside.dialogue');

            var hideBtns = document.querySelectorAll('[data-action=hide]');
            for (var i = 0; i < hideBtns.length; i++) {
                hideBtns[i].addEventListener('click', function() {
                    dialogue.hidden = true;
                });
            }

            var urlBtns = document.querySelectorAll('[data-action=url]');
            for (var i = 0; i < urlBtns.length; i++) {
                (function(btn) {
                    btn.addEventListener('click', function() {
                        window.location = btn.dataset.url;
                    });
                }(urlBtns[i]));
            }

            var forceBtns = document.querySelectorAll('[data-action=force]');
            for (var i = 0; i < forceBtns.length; i++) {
                forceBtns[i].addEventListener('click', function() {
                    document.querySelector('input[name=force]').value = 'on';
                    document.querySelector('form').submit();
                });
            }
        </script>
    {% endif %}

    <script type="text/javascript">
        var valid_token_regex = /^[GOPWY]*$/;

        var token_input_change = function(input) {
            input.value = input.value.toUpperCase();
            validate_token_input(input);
        };
        var validate_token_input = function(input) {
            if (input.value.match(valid_token_regex)) {
                input.className = '';
            } else {
                input.className = 'invalid';
            }
        };

        var tokenInputs = document.querySelectorAll('input[type=text].tokens');
        for (var i = 0; i < tokenInputs.length; i++) {
            validate_token_input(tokenInputs[i]);
        }

        var valid_robot_tlas = [
            {% for tla, team in teams | dictsort %}
                '{{ tla }}'{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        var robot_tla_input_change = function(input) {
            input.value = input.value.toUpperCase();
            validate_robot_tla_input(input);
        };
        var validate_robot_tla_input = function(input) {
            var parts = input.value.split(' ').filter(function(x){ return x; });
            for (var i=0; i<parts.length; i++) {
                if (valid_robot_tlas.indexOf(parts[i]) !== -1) {
                    input.className = '';
                } else {
                    input.className = 'invalid';
                    break;
                }
            }
        };

        var robotTlaInputs = document.querySelectorAll('input[type=text].robot-tlas');
        for (var i = 0; i < robotTlaInputs.length; i++) {
            validate_robot_tla_input(robotTlaInputs[i]);
        }
    </script>
{% endblock %}
