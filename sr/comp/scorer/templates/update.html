{% extends "_base.html" %}

{% block head %}
    <link href="{{ url_for('static', filename='styles/score-sheet.css') }}" rel="stylesheet" />
{% endblock %}

{% block hint %}
    <p>
        <a href="{{ url_for('.index') }}">Return to match selection</a>
        <a href="{{ url_for('.update', arena=match.arena, num=match.num - 1) }}">Previous match</a>
        <a href="{{ url_for('.update', arena=match.arena, num=match.num + 1) }}">Next match</a>

        {% for name, arena in arenas.items() %}
            {% if name != match['arena'] %}
                <a href="{{ url_for('.update', arena=name, num=match.num) }}">Arena {{ arena.display_name }}</a>
            {% endif %}
        {% endfor %}
    </p>
{% endblock %}

{% macro input_tla(x, y, corner) %}
    {% set current = request.form.get('tla_{}'.format(corner)) %}
    <foreignObject x="{{ x }}" y="{{ y }}" width="40" height="30">
        <label for="tla_{{ corner }}">TLA</label>
    </foreignObject>
    <foreignObject x="{{ x + 45 }}" y="{{ y }}" width="100" height="30">
        <select id="tla_{{ corner }}" name="tla_{{ corner }}">
            <option value=""></option>
            {% for tla, team in teams | dictsort %}
                <option value="{{ tla }}" {{ 'selected' if current == tla else '' }}>{{ tla }}</option>
            {% endfor %}
        </select>
    </foreignObject>
{% endmacro %}

{% macro input_tokens_ground(x, y, id) %}
    <foreignObject x="{{ x + 8 }}" y="{{ y - 15 }}" width="80" height="30">
        <label for="tokens_ground_{{ id }}" title="Tokens on the ground in a scoring zone">Tokens</label>
    </foreignObject>
    <foreignObject x="{{ x }}" y="{{ y + 15 }}" width="100" height="30">
        <input
            type="text"
            class="tokens"
            id="tokens_ground_{{ id }}"
            name="tokens_ground_{{ id }}"
            placeholder="on ground"
            value="{{ request.form.get('tokens_ground_{}'.format(id)) | empty_if_none }}"
            onkeyup="token_input_change(this);"
        />
    </foreignObject>
{% endmacro %}

{% macro input_tokens_platform(x, y, id) %}
    <foreignObject x="{{ x + 8 }}" y="{{ y - 15 }}" width="80" height="30">
        <label for="tokens_platform_{{ id }}" title="Tokens on the raised area in a scoring zone">Tokens</label>
    </foreignObject>
    <foreignObject x="{{ x }}" y="{{ y + 15 }}" width="100" height="30">
        <input
            type="text"
            class="tokens"
            id="tokens_platform_{{ id }}"
            name="tokens_platform_{{ id }}"
            placeholder="on platform"
            value="{{ request.form.get('tokens_platform_{}'.format(id)) | empty_if_none }}"
            onkeyup="token_input_change(this);"
        />
    </foreignObject>
{% endmacro %}

{% macro input_present(x, y, corner) %}
    <foreignObject x="{{ x }}" y="{{ y }}" width="80" height="30">
        <label for="present_{{ corner }}">Present</label>
    </foreignObject>
    <foreignObject x="{{ x + 85 }}" y="{{ y }}" width="30" height="30">
        <input type="checkbox" id="present_{{ corner }}" name="present_{{ corner }}" value="on" {{ 'checked' if request.form.get('present_{}'.format(corner)) else '' }} />
    </foreignObject>
{% endmacro %}

{% macro input_disqualified(x, y, corner) %}
    <foreignObject x="{{ x }}" y="{{ y }}" width="120" height="30">
        <label for="disqualified_{{ corner }}">Disqualified</label>
    </foreignObject>
    <foreignObject x="{{ x + 125 }}" y="{{ y }}" width="30" height="30">
        <input type="checkbox" id="disqualified_{{ corner }}" name="disqualified_{{ corner }}" value="on" {{ 'checked' if request.form.get('disqualified_{}'.format(corner)) else '' }} />
    </foreignObject>
{% endmacro %}

{% macro input_tokens_held(x, y, id) %}
    <foreignObject x="{{ x - 40 }}" y="{{ y }}" width="80" height="30">
        <label for="tokens_held_{{ id }}">Tokens</label>
    </foreignObject>
    <foreignObject x="{{ x + 45 }}" y="{{ y }}" width="100" height="30">
        <input
            type="text"
            class="tokens"
            id="tokens_held_{{ id }}"
            name="tokens_held_{{ id }}"
            placeholder="in robot"
            value="{{ request.form.get('tokens_held_{}'.format(id)) | empty_if_none }}"
            onkeyup="token_input_change(this);"
        />
    </foreignObject>
{% endmacro %}

{% macro input_tokens_elsewhere(x, y) %}
    <foreignObject x="{{ x - 85 }}" y="{{ y }}" width="170" height="30">
        <label for="tokens_elsewhere">Tokens elsewhere</label>
    </foreignObject>
    <foreignObject x="{{ x + 90 }}" y="{{ y }}" width="100" height="30">
        <input
            type="text"
            class="tokens"
            id="tokens_elsewhere"
            name="tokens_elsewhere"
            placeholder="tokens"
            value="{{ request.form.get('tokens_elsewhere') | empty_if_none }}"
            onkeyup="token_input_change(this);"
        />
    </foreignObject>
{% endmacro %}

{% block main %}
    <div class="score-sheet"
    {% set arena_colour_raw = arenas[match['arena']].colour %}
    {% if arena_colour_raw %}
        {% set r, g, b = parse_hex_colour(arena_colour_raw) %}
        style="background: rgba({{ r }}, {{ g }}, {{ b }}, 0.15)"
    {% endif %}
    >
        <h1>
            {{ match['type'].value | title }}
            scores for
            {{ match['display_name'] }}
            {% if arenas|length > 1 %}
                in Arena
                {{ arenas[match['arena']].display_name }}
            {% endif %}
        </h1>

        <form method="POST">
            <svg xmlns="http://www.w3.org/2000/svg" height="890" width="600" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink">
                <g font-size="1.2em" fill="#4d4d4d">
                    <text><tspan y="25" x="125">Area 0</tspan></text>
                    <text><tspan y="25" x="425">Area 1</tspan></text>
                    <text><tspan y="840" x="425">Area 2</tspan></text>
                    <text><tspan y="840" x="125">Area 3</tspan></text>
                </g>

                <!-- Area 0 -->
                {{ input_tla(10, 40, 0) }}
                {{ input_present(170, 40, 0) }}
                {{ input_disqualified(130, 70, 0) }}
                {{ input_tokens_held(110, 110, 0) }}

                <!-- Area 1 -->
                {{ input_tla(310, 40, 1) }}
                {{ input_present(470, 40, 1) }}
                {{ input_disqualified(430, 70, 1) }}
                {{ input_tokens_held(410, 110, 1) }}

                <g transform="translate(0, 710)">
                    <!-- Area 2 -->
                    {{ input_tla(310, 40, 2) }}
                    {{ input_present(470, 40, 2) }}
                    {{ input_disqualified(430, 70, 2) }}
                    {{ input_tokens_held(410, -10, 2) }}

                    <!-- Area 3 -->
                    {{ input_tla(10, 40, 3) }}
                    {{ input_present(170, 40, 3) }}
                    {{ input_disqualified(130, 70, 3) }}
                    {{ input_tokens_held(110, -10, 3) }}
                </g>

                <g transform="translate(60, 180)">
                    <rect height="480" width="480" stroke="#000" y="0" x="0" stroke-width="1" fill="#f8f7ff"/>
                    <rect height="240" width="240" stroke="#000" y="120" x="120" stroke-width="1" fill="#f8f7ff"/>

                    <path d="M240 0 V 480" stroke="#000" stroke-width="1"/>
                    <path d="M0 240 H 480" stroke="#000" stroke-width="1"/>

                    {{ input_tokens_ground( 30, 380, '0') }}
                    {{ input_tokens_ground( 30,  60, '1') }}
                    {{ input_tokens_ground(350,  60, '2') }}
                    {{ input_tokens_ground(350, 380, '3') }}

                    {{ input_tokens_platform(130, 285, '0') }}
                    {{ input_tokens_platform(130, 165, '1') }}
                    {{ input_tokens_platform(250, 165, '2') }}
                    {{ input_tokens_platform(250, 285, '3') }}

                    <g font-size="1.2em" fill="#4d4d4d">
                        <text><tspan y="460" x="30">Zone 0</tspan></text>
                        <text><tspan y="30" x="30">Zone 1</tspan></text>
                        <text><tspan y="30" x="380">Zone 2</tspan></text>
                        <text><tspan y="460" x="380">Zone 3</tspan></text>
                    </g>
                </g>

                <g transform="translate(0, 860)">
                    {{ input_tokens_elsewhere(225, 0) }}
                </g>
            </svg>

            <input type="hidden" name="force" />
            <input type="submit" value="Enter Scores" />
        </form>
    </div>

    {% if error %}
        <aside class="dialogue fail">
            <div>
                <h1>Validation Error!</h1>
                <pre>{{ error }}</pre>
                <button data-action="hide">Correct problems</button>
                <button data-action="force">Save anyway</button>
            </div>
        </aside>
    {% elif done %}
        <aside class="dialogue success">
            <div>
                <h1>Success!</h1>
                <p>The scores have been updated successfully.</p>

                <button data-action="url" data-url="{{ url_for('.index') }}">Select another match</button>
                <button data-action="url" data-url="{{ url_for('.update', arena=match.arena, num=match.num - 1) }}">Previous match</button>
                <button data-action="url" data-url="{{ url_for('.update', arena=match.arena, num=match.num + 1) }}">Next match</button>

                {% for name, arena in arenas.items() %}
                    {% if name != match['arena'] %}
                        <button data-action="url" data-url="{{ url_for('.update', arena=name, num=match.num) }}">Arena {{ arena.display_name }}</button>
                    {% endif %}
                {% endfor %}

                <button data-action="hide">Amend scores</button>
            </div>
        </aside>
    {% endif %}

    {% if error or done %}
        <script>
            var dialogue = document.querySelector('aside.dialogue');

            var hideBtns = document.querySelectorAll('[data-action=hide]');
            for (var i = 0; i < hideBtns.length; i++) {
                hideBtns[i].addEventListener('click', function() {
                    dialogue.hidden = true;
                });
            }

            var urlBtns = document.querySelectorAll('[data-action=url]');
            for (var i = 0; i < urlBtns.length; i++) {
                (function(btn) {
                    btn.addEventListener('click', function() {
                        window.location = btn.dataset.url;
                    });
                }(urlBtns[i]));
            }

            var forceBtns = document.querySelectorAll('[data-action=force]');
            for (var i = 0; i < forceBtns.length; i++) {
                forceBtns[i].addEventListener('click', function() {
                    document.querySelector('input[name=force]').value = 'on';
                    document.querySelector('form').submit();
                });
            }
        </script>
    {% endif %}

    <script type="text/javascript">
        var valid_token_regex = /^\d*$/;

        var token_input_change = function(input) {
            input.value = input.value.toUpperCase();
            validate_token_input(input);
        };
        var validate_token_input = function(input) {
            if (input.value.match(valid_token_regex)) {
                input.className = '';
            } else {
                input.className = 'invalid';
            }
        };

        var tokenInputs = document.querySelectorAll('input[type=text].tokens');
        for (var i = 0; i < tokenInputs.length; i++) {
            validate_token_input(tokenInputs[i]);
        }
    </script>
{% endblock %}
